<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guía / Nota de Envío – Super Panda</title>

  <!-- Estilos base (idénticos a Ventas) -->
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/sweetalert2.css" />
  <link rel="stylesheet" href="css/material.min.css" />
  <link rel="stylesheet" href="css/material-design-iconic-font.min.css" />
  <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css" />
  <link rel="stylesheet" href="css/main.css" />

  <!-- Scripts base (no-módulo) -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
  <script src="js/material.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="js/main.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- ======= Sidebar (igual que Ventas) ======= -->
<section class="full-width navLateral">
  <div class="full-width navLateral-bg btn-menu"></div>
  <div class="full-width navLateral-body">
    <div class="full-width navLateral-body-logo text-center tittles">
      <i class="zmdi zmdi-close btn-menu"></i> Envíos – Plaza NIXKAB
    </div>
    <figure class="full-width" style="height: 77px;">
      <div class="navLateral-body-cl">
        <img src="assets/img/logo.png" alt="Logo" />
      </div>
      <figcaption class="navLateral-body-cr hide-on-tablet">
        <span><br /><small></small></span>
      </figcaption>
    </figure>

    <div class="full-width tittles navLateral-body-tittle-menu">
      <i class="zmdi zmdi-desktop-mac"></i><span class="hide-on-tablet"> MENÚ</span>
    </div>

    <nav class="full-width">
      <ul class="full-width list-unstyle menu-principal">
       <li><a href="home_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-view-dashboard"></i></div><div class="navLateral-body-cr hide-on-tablet">Inicio</div></a></li>
          <li><a href="inventory_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-store"></i></div><div class="navLateral-body-cr hide-on-tablet">Inventario</div></a></li>
          <li><a href="client_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-accounts"></i></div><div class="navLateral-body-cr hide-on-tablet">Clientes</div></a></li>
          <li><a href="sales_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-basket"></i></div><div class="navLateral-body-cr hide-on-tablet">Compras</div></a></li>
          <li><a href="providers_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-truck"></i></div><div class="navLateral-body-cr hide-on-tablet">Proveedores</div></a></li>
          <li><a href="ventas_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-shopping-cart"></i></div><div class="navLateral-body-cr hide-on-tablet">Ventas</div></a></li>
          <li><a href="cuentas-cobrar_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-balance-wallet"></i></div><div class="navLateral-body-cr hide-on-tablet">Cuentas por cobrar</div></a></li>
        <li><a href="generar_xls_19calle.html" class="full-width"><div class="navLateral-body-cl"><i class="zmdi zmdi-file"></i></div><div class="navLateral-body-cr hide-on-tablet">Generar XLS</div></a></li>
          <li><a href="envio_19calle.html" class="full-width active"><div class="navLateral-body-cl"><i class="zmdi zmdi-local-shipping"></i></div><div class="navLateral-body-cr hide-on-tablet">Guía / Nota de envío</div></a></li>

    </ul>
    </nav>
  </div>
</section>

<!-- ======= Top Nav (igual que Ventas) ======= -->
<div class="full-width navBar">
  <div class="full-width navBar-options">
    <i class="zmdi zmdi-more-vert btn-menu" id="btn-menu"></i>
    <nav class="navBar-options-list">
      <ul class="list-unstyle">
        <li class="btn-exit" onclick="try{ logout&&logout(); }catch(e){}">
          <i class="zmdi zmdi-power"></i>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- ======= Contenido ======= -->
<section class="full-width pageContent">
  <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--8-col mdl-cell--2-offset-desktop">
      <div class="full-width panel mdl-shadow--2dp">
        <div class="full-width panel-tittle bg-primary text-center tittles">
          Generar PDF de envío / nota
        </div>

        <div class="full-width panel-content">
          <!-- Cliente -->
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty">
            <select id="selCliente" class="mdl-textfield__input">
              <option value="">Selecciona un cliente...</option>
            </select>
            <label class="mdl-textfield__label" for="selCliente">Cliente</label>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="clienteNombre" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="clienteNombre">Nombre del cliente</label>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="clienteTelefono" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="clienteTelefono">Número del cliente</label>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="clienteNegocio" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="clienteNegocio">Negocio / Empresa</label>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="clienteDireccion" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="clienteDireccion">Dirección del negocio / cliente</label>
          </div>

          <hr />

          <!-- Transporte -->
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="transporteNombre" list="listaTransportes" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="transporteNombre">Transporte (escribe o selecciona)</label>
            <datalist id="listaTransportes"></datalist>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="transporteDireccion" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="transporteDireccion">Dirección del transporte</label>
          </div>

          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input id="transporteNumero" class="mdl-textfield__input" type="text" />
            <label class="mdl-textfield__label" for="transporteNumero">Número del transporte</label>
          </div>

          <hr />

          <!-- Descripción -->
          <div class="mdl-textfield mdl-js-textfield">
            <textarea id="descripcion" class="mdl-textfield__input" rows="4"></textarea>
            <label class="mdl-textfield__label" for="descripcion">Descripción (opcional)</label>
          </div>

          <p class="text-center">
            <button id="btnGenerar" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
              <i class="zmdi zmdi-print"></i> Generar PDF
            </button>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========================= APP (módulo) ========================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  // --- Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDg4jxoL6LnaWVLqdfu48SdBfH-8T3hVzA",
    authDomain: "superpanda-a89c0.firebaseapp.com",
    projectId: "superpanda-a89c0",
    storageBucket: "superpanda-a89c0.firebasestorage.app",
    messagingSenderId: "730819312861",
    appId: "1:730819312861:web:4a60912c859691d45a6f34"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  onAuthStateChanged(auth, (user) => {
    if (!user) console.warn("No autenticado (solo lectura de clientes).");
  });

  // --- UI refs ---
  const selCliente = document.getElementById("selCliente");
  const clienteNombre    = document.getElementById("clienteNombre");
  const clienteTelefono  = document.getElementById("clienteTelefono");
  const clienteNegocio   = document.getElementById("clienteNegocio");
  const clienteDireccion = document.getElementById("clienteDireccion");

  const transporteNombre    = document.getElementById("transporteNombre");
  const transporteDireccion = document.getElementById("transporteDireccion");
  const transporteNumero    = document.getElementById("transporteNumero");
  const listaTransportes    = document.getElementById("listaTransportes");

  const descripcion = document.getElementById("descripcion");
  const btnGenerar  = document.getElementById("btnGenerar");

  // --- Caches ---
  const clientesCache = {};
  const transportesCache = new Map(); // nombre -> {direccion, numero}

  // --- Cargar clientes + armar lista de transportes ---
  onValue(ref(db, "clientes"), (snap) => {
    const data = snap.val() || {};
    selCliente.innerHTML = '<option value="">Selecciona un cliente...</option>';
    transportesCache.clear();

    Object.entries(data).forEach(([codigo, c]) => {
      clientesCache[codigo] = c;
      const opt = document.createElement("option");
      const nombre = `${c.nombre || ""} ${c.apellido || ""}`.trim();
      opt.value = codigo;
      opt.textContent = `${nombre}${c.negocio ? " – " + c.negocio : ""}`;
      selCliente.appendChild(opt);

      if (c.transporte) {
        if (!transportesCache.has(c.transporte)) {
          transportesCache.set(c.transporte, {
            direccion: c.transporteDireccion || "",
            numero: c.transporteNumero || ""
          });
        }
      }
    });

    // datalist
    listaTransportes.innerHTML = Array.from(transportesCache.keys())
      .sort((a,b)=>a.localeCompare(b))
      .map(t => `<option value="${t}"></option>`).join("");

    if (window.componentHandler) componentHandler.upgradeDom();
  });

  // --- Autorrellenar al seleccionar cliente ---
  selCliente.addEventListener("change", () => {
    const c = clientesCache[selCliente.value];
    if (!c) {
      clienteNombre.value = "";
      clienteTelefono.value = "";
      clienteNegocio.value = "";
      clienteDireccion.value = "";
      if (window.componentHandler) componentHandler.upgradeDom();
      return;
    }
    clienteNombre.value    = `${c.nombre || ""} ${c.apellido || ""}`.trim();
    clienteTelefono.value  = c.telefono || "";
    clienteNegocio.value   = c.negocio || "";
    clienteDireccion.value = c.direccion || "";

    // si tiene transporte guardado lo usamos como sugerencia
    if (c.transporte) {
      transporteNombre.value    = c.transporte || "";
      transporteDireccion.value = c.transporteDireccion || "";
      transporteNumero.value    = c.transporteNumero || "";
    }

    document.querySelectorAll('.mdl-textfield').forEach(el => el.classList.add('is-dirty'));
    if (window.componentHandler) componentHandler.upgradeDom();
  });

  // --- Al elegir transporte de la lista, completar dirección y número ---
  transporteNombre.addEventListener("change", () => {
    const t = transportesCache.get(transporteNombre.value);
    if (t) {
      transporteDireccion.value = t.direccion || "";
      transporteNumero.value    = t.numero || "";
      document.querySelectorAll('.mdl-textfield').forEach(el => el.classList.add('is-dirty'));
      if (window.componentHandler) componentHandler.upgradeDom();
    }
  });

  // --- Generar PDF ---
  btnGenerar.addEventListener("click", () => {
    const nombre    = (clienteNombre.value || "").trim();
    const numero    = (clienteTelefono.value || "").trim();
    const negocio   = (clienteNegocio.value || "").trim();
    const dir       = (clienteDireccion.value || "").trim();

    const tNombre   = (transporteNombre.value || "").trim();
    const tDir      = (transporteDireccion.value || "").trim();
    const tNumero   = (transporteNumero.value || "").trim();

    const desc      = (descripcion.value || "").trim();

    // Validación simple visual como en otras pantallas
    if (!nombre) {
      Swal.fire("Cliente requerido", "Selecciona un cliente o escribe su nombre.", "info");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "letter" });

    // Encabezado visual
    try { doc.addImage("assets/img/logo.png", "PNG", 20, 10, 25, 25); } catch(e) {}
    doc.setFontSize(16);
    doc.text("SUPER PANDA", 50, 18);
    doc.setFontSize(11);
    doc.text("GUÍA / NOTA DE ENVÍO", 50, 25);

    let y = 40;

    // Cliente
    doc.setFontSize(12);
    doc.text(`Cliente: ${nombre || "-"}`, 20, y); y += 7;
    doc.text(`Número: ${numero || "-"}`, 20, y); y += 7;
    const lineaDir = negocio ? `Dirección ${negocio}: ${dir || "-"}` : `Dirección: ${dir || "-"}`;
    const lineasDir = doc.splitTextToSize(lineaDir, 175);
    doc.text(lineasDir, 20, y); 
    y += (lineasDir.length * 6) + 6;

    // Transporte
    if (tNombre || tDir || tNumero) {
      doc.setFontSize(12);
      doc.text("Transporte", 20, y); y += 6;
      if (tNombre) doc.text(`Nombre: ${tNombre}`, 20, y), y += 6;
      if (tDir)    {
        const lt = doc.splitTextToSize(`Dirección: ${tDir}`, 175);
        doc.text(lt, 20, y);
        y += (lt.length * 6);
      }
      if (tNumero) doc.text(`Número: ${tNumero}`, 20, y), y += 6;
      y += 4;
    }

    // Descripción
    if (desc) {
      doc.setFontSize(12);
      doc.text("Descripción:", 20, y); y += 6;
      const maxWidth = 175;
      const lineas = doc.splitTextToSize(desc, maxWidth);
      doc.text(lineas, 20, y);
      y += (lineas.length * 6) + 6;
    } else {
      y += 6;
    }

    // Pie con datos fijos y logo
    const pieY = 245;
    doc.setFontSize(10);
    doc.text("Carretera Interamericana 0-10", 45, pieY);
    doc.text("bodega 17 Plaza Nixkab zona 2 Mixco", 45, pieY + 6);
    doc.text("Cel: 5485-6783 / 4183-6999", 45, pieY + 12);
    doc.text("Súper Panda", 45, pieY + 18);

    try { doc.addImage("assets/img/logo.png", "PNG", 160, pieY - 5, 35, 35); } catch (e) {
      console.warn("No se pudo cargar el logo:", e);
    }

    const nombreArchivo = `guia_superpanda_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
  });
</script>

</body>
</html>
